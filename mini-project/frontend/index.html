<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบนับจำนวนยานพาหนะ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <style>
        .card {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .card:hover {
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        .result-table {
            margin-top: 20px;
        }
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .loading.active {
            display: flex;
        }
    </style>
</head>
<body class="bg-light">
    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">กำลังโหลด...</span>
        </div>
    </div>

    <div class="container py-5">
        <h1 class="text-center mb-4">ระบบนับจำนวนยานพาหนะ</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="searchForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">ประเภท</label>
                            <select class="form-select" id="type" required>
                                <option value="gate">ประตู</option>
                                <option value="camera">กล้อง</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">รหัส</label>
                            <input type="number" class="form-control" id="id" required min="1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">วันที่เริ่มต้น</label>
                            <input type="date" class="form-control" id="start" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">วันที่สิ้นสุด</label>
                            <input type="date" class="form-control" id="stop" required>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button type="submit" class="btn btn-primary px-4">ค้นหา</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="results" class="card">
            <div class="card-body">
                <h3 class="card-title mb-4">ผลการค้นหา</h3>
                <div class="table-responsive mb-4">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>รหัสกล้อง</th>
                                <th>ประเภทยานพาหนะ</th>
                                <th>ทิศทาง</th>
                                <th>จำนวน</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <!-- Results will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4">
                    <h4>แผนภูมิแสดงจำนวนยานพาหนะ</h4>
                    <canvas id="vehicleChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        let vehicleChart = null;

        // Initialize date pickers
        flatpickr("#start", {
            dateFormat: "Y-m-d",
        });
        flatpickr("#stop", {
            dateFormat: "Y-m-d",
        });

        function initializeChart(data) {
            const ctx = document.getElementById('vehicleChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (vehicleChart) {
                vehicleChart.destroy();
            }

            // Prepare data for the chart
            const chartData = {
                labels: [],
                datasets: []
            };

            // Process data for the chart
            if (data && data.length > 0 && data[0].details) {
                // Get unique vehicle types
                const vehicleTypes = [...new Set(data.flatMap(item => 
                    item.details.map(detail => detail.vehicle_type_name)
                ))];

                // Get unique directions
                const directions = [...new Set(data.flatMap(item => 
                    item.details.map(detail => detail.direction_type_name)
                ))];

                // Create datasets for each direction
                directions.forEach((direction, index) => {
                    const colors = ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)'];
                    chartData.datasets.push({
                        label: direction,
                        data: vehicleTypes.map(type => {
                            const count = data.reduce((sum, item) => {
                                const detail = item.details.find(d => 
                                    d.vehicle_type_name === type && 
                                    d.direction_type_name === direction
                                );
                                return sum + (detail ? detail.count : 0);
                            }, 0);
                            return count;
                        }),
                        backgroundColor: colors[index % colors.length],
                        borderColor: colors[index % colors.length].replace('0.6', '1'),
                        borderWidth: 1
                    });
                });

                chartData.labels = vehicleTypes;
            }

            // Create new chart
            vehicleChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'จำนวน'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ประเภทยานพาหนะ'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'จำนวนยานพาหนะแยกตามประเภทและทิศทาง'
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Form submission handler
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const type = document.getElementById('type').value;
            const id = document.getElementById('id').value;
            const start = document.getElementById('start').value;
            const stop = document.getElementById('stop').value;

            // Show loading
            document.querySelector('.loading').classList.add('active');

            try {
                const response = await fetch(`http://localhost:5678/webhook/vehicle_count/all?type=${type}&id=${id}&start=${start}&stop=${stop}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // ตรวจสอบว่ามี response content หรือไม่
                const text = await response.text();
                if (!text) {
                    throw new Error('ไม่มีข้อมูลจากเซิร์ฟเวอร์');
                }

                // พยายาม parse JSON
                let responseData;
                try {
                    responseData = JSON.parse(text);
                } catch (e) {
                    console.error('ข้อมูลที่ได้รับ:', text);
                    throw new Error('ข้อมูลที่ได้รับไม่อยู่ในรูปแบบ JSON ที่ถูกต้อง');
                }
                
                console.log('ข้อมูลที่ได้รับ:', JSON.stringify(responseData, null, 2));
                
                // Clear previous results
                const tbody = document.getElementById('resultsBody');
                tbody.innerHTML = '';

                // ตรวจสอบโครงสร้างข้อมูล
                if (!responseData || !Array.isArray(responseData) || !responseData[0]?.data) {
                    throw new Error('รูปแบบข้อมูลที่ได้รับไม่ถูกต้อง');
                }

                // ใช้ข้อมูลจาก responseData[0].data
                const data = responseData[0].data;

                // Process and display results
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="4" class="text-center">ไม่พบข้อมูล</td>';
                    tbody.appendChild(row);
                    // Initialize empty chart
                    initializeChart([]);
                    return;
                }

                data.forEach(item => {
                    if (item.details && Array.isArray(item.details)) {
                        item.details.forEach(detail => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.camera_id || 'ไม่ระบุ'}</td>
                                <td>${detail.vehicle_type_name || 'ไม่ระบุ'}</td>
                                <td>${detail.direction_type_name || 'ไม่ระบุ'}</td>
                                <td>${detail.count || 0}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                });

                // Initialize chart with data
                initializeChart(data);

            } catch (error) {
                console.error('รายละเอียดข้อผิดพลาด:', error);
                let errorMessage = 'เกิดข้อผิดพลาดในการดึงข้อมูล';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบว่า n8n กำลังทำงานที่พอร์ต 5678';
                } else if (error.message.includes('HTTP error')) {
                    errorMessage = `ข้อผิดพลาดจากเซิร์ฟเวอร์: ${error.message}`;
                } else if (error.message.includes('JSON')) {
                    errorMessage = 'ข้อมูลที่ได้รับจากเซิร์ฟเวอร์ไม่ถูกต้อง กรุณาตรวจสอบการตั้งค่า n8n';
                } else {
                    errorMessage = `เกิดข้อผิดพลาด: ${error.message}`;
                }
                
                console.log('ประเภทข้อผิดพลาด:', error.name);
                console.log('ข้อความผิดพลาด:', error.message);
                console.log('รายละเอียดข้อผิดพลาด:', error.stack);
                
                alert(errorMessage);
                
                const tbody = document.getElementById('resultsBody');
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${errorMessage}</td></tr>`;
            } finally {
                // Hide loading
                document.querySelector('.loading').classList.remove('active');
            }
        });
    </script>
</body>
</html>
